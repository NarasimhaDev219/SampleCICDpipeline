# Android
# Build your Android project with Gradle.
# Add steps that test, sign, and distribute the APK, save build artifacts, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/android

trigger:
- master

pool:
  vmImage: 'macos-latest'


variables:
  JAVA_HOME: 'Library/Java/JavaVirtualMachines/jdk-11.jdk/Contents/Home'
  keystorePassword: '123456'
  keyPassword: '123456'

steps:
- task: Gradle@2
  displayName: 'Gradle@2'
  inputs:
    gradleWrapperFile: 'gradlew'
    architecture: 'x64'
    workingDirectory: ''
    tasks: 'assembleRelease'
    publishJUnitResults: false
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '11'
    gradleOptions: '-Xmx3072m -Xms3072m -XX:NewSize=1024m -XX:MaxNewSize=1024m -XX:+UseParallelGC'
    androidSigningScheme: 'apkSignature'
    signingConfigName: 'release'
    runTestsInBackground: false
    checkStyleRunAnalysis: true
    findBugsRunAnalysis: true
    pmdRunAnalysis: true
    testResultsFiles: '**/TEST-*.xml'
    buildType: 'Release'
    analysisResultsFiles: '**/reports/*-checkstyle.xml,**/reports/*-findbugs.xml,**/reports/*-pmd.xml'

- task: CopyFiles@2
  displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
  inputs:
    SourceFolder: '$(system.defaultworkingdirectory)'
    Contents: '**/*.apk'
    TargetFolder: '$(build.artifactstagingdirectory)'
  condition: succeededOrFailed()

- task: AndroidSigning@3
  displayName: 'Build and sign APK'
  inputs:
    apkFiles: '$(build.artifactStagingDirectory)/*.apk'
    apksignerKeystoreFile: '/Users/narasimharaoy/KeystorePath/newsapp_keystorepath'
    apksignerKeystorePassword: '$(123456)'
    apksignerKeystoreAlias: 'key0'
    apksignerKeyPassword: '$(123456)'
    apksignerArguments: '--out $(build.artifactStagingDirectory)/$(apkName)-signed.apk'


- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop'
 
- task: AppCenterDistribute@3
  displayName: Distribute release to App Center
  inputs:
    serverEndpoint: 'UpdatedBuild'
    appSlug: 'narasimharaoy.in-mouritech.com/SampleCICDpipeline'
    releaseNotesOption: 'input'
    appFile: '**/*.apk'
    artifactsPattern: '**/*.apk'
    releaseNotesInput: 'New features and bug fixes'
    destinationType: 'groups'
    distributionGroup: 'MyAppDemo'
    isMandatory: true
    distributionGroupId: 'fbc8c624-5cbd-42c6-bf52-f712edf94605'
    filePattern: '$(build.artifactstagingdirectory)/*.apk'
  enabled: true
  condition: succeededOrFailed()




    